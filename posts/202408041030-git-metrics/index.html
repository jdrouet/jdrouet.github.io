<!doctype html><html lang=en-US xml:lang=en-US><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="text/html;charset=utf-8" http-equiv=Content-Type><link href=/favicon.svg rel=icon type=image/svg><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/main.css rel=stylesheet><meta content=#151515 name=theme-color><meta content=#151515 name=msapplication-navbutton-color><meta content=black-translucent name=apple-mobile-web-app-status-bar-style><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>jdrouet > Build metrics and budgets with git-metrics</title><meta content=Zola name=generator><meta content="Or how to monitor your binary size, code coverage or webpage size without relying on an external service." name=description><meta content="J√©r√©mie Drouet" name=author><link href=/posts/202408041030-git-metrics/ rel=canonical><meta content="Build metrics and budgets with git-metrics" property=og:title><meta content="Or how to monitor your binary size, code coverage or webpage size without relying on an external service." property=og:description><meta content=article property=og:type><meta content=/posts/202408041030-git-metrics/ property=og:url><meta content=/images/logo.png property=og:image><meta content=jdrouet property=og:site_name><meta content=en_US property=og:locale><meta content=2024-08-04T00:00:00+00:00 property=article:published_time><body><header><div class=container><a href=/ id=a-title> <h1>üßë‚Äçüíª jdrouet</h1> </a><h2>My projects, my thoughts and other things.</h2><nav id=navbar><a alt="Link to Home" class=btn href=/> Home </a><a alt="Link to LinkedIn profile" class=btn href=https://www.linkedin.com/in/jeremiedrouet target=_blank> <span class="icon icon-linkedin"></span>About me</a><a alt="Link to GitHub profile" class=btn href=https://github.com/jdrouet target=_blank> <span class="icon icon-github"></span>jdrouet</a><a alt="Link to Mastodon profile" class=btn href=https://mamot.fr/@jdrouet target=_blank> <span class="icon icon-mastodon"></span>@jdrouet</a></nav><div class=job-status><span class=job-status-dot>‚óè</span><span class=job-status-text> Open to new opportunities - <a href=https://www.linkedin.com/in/jeremiedrouet target=_blank>Let's connect on LinkedIn</a> or <a href=mailto:hire@jdrouet.fr>contact me</a> </span></div></div></header><div class=container><main><article class=page><div class=header-container><h2>üßë‚Äçüíª Build metrics and budgets with git-metrics</h2></div><div class=page-info><div class="page-tags mb-1em">Tags = [ <a class=page-tag href=/tags/metrics/>metrics</a>, <a class=page-tag href=/tags/git/>git</a>, <a class=page-tag href=/tags/cli/>cli</a>, <a class=page-tag href=/tags/rust/>rust</a> ]</div><time class="page-time smaller" datetime=2024-08-04T00:00:00+00:00> Posted on 2024-08-04 </time></div><div class=entry><p>Monitoring metrics for a project can be challenging. Deciding what to track, determining the cardinality of each tag, naming the metrics, and choosing what should be split into a tag or kept as a metric are all complex tasks that require experience.<p>But monitoring the run of your project is not the only thing we need to monitor; the development phase is also important. Code coverage is a good example of how we monitor the build of a project. Many projects implement rules to prevent code coverage from decreasing. In the frontend world, there is a growing trend to track metrics such as page size and load time. This kind of monitoring might seem less complicated, but determining where and how to store the metrics is more challenging.<p>In recent years, I've been working on several projects where I wanted to put in place such boundaries. When looking at how to implement that, I always ended up using multiple external services or deploying applications to store those metrics that I would have to keep running all the time. This didn't match my requirements. I wanted to keep that cheap in terms of resource usage and low in terms of maintenance. I don't want to have a VPS running 24/7 just to push some metrics.<p>With global warming already well established, and human activity being the principal reason for it, we should rethink the way we build software. We cannot keep increasing exponentially the resource usage of our systems. Therefore, we need to put in place boundaries on the projects we build.<h2 id=state-of-the-art>State of the Art</h2><p>For open-source projects, many SaaS platforms offer free tiers for monitoring. For tracking code coverage, you can use <a href=https://codecov.io rel=noopener target=_blank>Codecov</a> or <a href=https://coveralls.io rel=noopener target=_blank>Coveralls</a>. For tracking complexity, <a href=https://codeclimate.com rel=noopener target=_blank>CodeClimate</a> is a good option. These platforms integrate well with GitHub repositories.<p>For closed-source projects, these SaaS platforms offer paid subscriptions, which may require budget considerations. Alternatively, if your DevOps team has the bandwidth, you can set up tools like <a href=https://www.sonarsource.com/products/sonarqube/ rel=noopener target=_blank>SonarQube</a> for in-house monitoring.<p>However, be prepared for potential vendor lock-in, which can make switching services or losing historical data problematic.<h2 id=alternative-approach>Alternative Approach</h2><p>Shouldn‚Äôt the metrics related to the code be attached to the code itself?<p>Some projects, such as <a href=https://github.com/actions/typescript-action rel=noopener target=_blank>typescript-action</a>, version code coverage alongside the code. This approach isn't perfect, as it requires developers to update the metrics for each commit, or you need a CI job to keep them in sync. However, keeping metrics directly in Git is appealing as it provides easy access and avoids reliance on external services. Switching from GitHub to GitLab, for instance, would be as simple as pushing the repository.<p>To address synchronization issues, instead of writing these metrics with the code, they can be kept next to it. Git offers a feature called <a href=https://git-scm.com/docs/git-notes rel=noopener target=_blank><code>notes</code></a>, which allows attaching textual data to a commit reference.<h2 id=solution-implementation>Solution Implementation</h2><p>This is where <a href=https://github.com/jdrouet/git-metrics rel=noopener target=_blank><code>git-metrics</code></a> comes into play.<h3 id=basic-usage>Basic Usage</h3><p>With <code>git-metrics</code>, you can attach, replace, or remove metrics for a given commit with a simple command:<pre class=language-bash data-lang=bash style=color:#cccece;background-color:#2b2c2f><code class=language-bash data-lang=bash><span style=color:#69c>$ git-metrics add my-metric-name</span><span style=color:#5fb3b3> --</span><span style=color:#f99157>tag </span><span style=color:#5fb3b3>"</span><span style=color:#99c794>foo: bar</span><span style=color:#5fb3b3>"</span><span style=color:#69c> 1024.0
</span></code></pre><p>To show the metrics attached to a given commit:<pre class=language-bash data-lang=bash style=color:#cccece;background-color:#2b2c2f><code class=language-bash data-lang=bash><span style=color:#69c>$ git metrics show </span><span style=color:#5fb3b3><</span><span style=color:#69c>commit-sha</span><span style=color:#5fb3b3>>
</span><span style=color:#69c>my-metric-name{foo=</span><span style=color:#5fb3b3>"</span><span style=color:#99c794>bar</span><span style=color:#5fb3b3>"</span><span>} </span><span style=color:#69c>1024.0
</span></code></pre><p>To display a list of all commits, or within a commit range:<pre class=language-bash data-lang=bash style=color:#cccece;background-color:#2b2c2f><code class=language-bash data-lang=bash><span style=color:#69c>$ git metrics diff HEAD</span><span style=color:#ec5f67>~</span><span style=color:#69c>2..HEAD
</span><span style=color:#69c>- my-metric-name</span><span style=color:#5fb3b3>{</span><span style=color:#69c>foo=</span><span style=color:#5fb3b3>"</span><span style=color:#99c794>bar</span><span style=color:#5fb3b3>"}</span><span style=color:#69c> 512.0
</span><span style=color:#69c>+ my-metric-name</span><span style=color:#5fb3b3>{</span><span style=color:#69c>foo=</span><span style=color:#5fb3b3>"</span><span style=color:#99c794>bar</span><span style=color:#5fb3b3>"}</span><span style=color:#69c> 1024.0 (+200.00 </span><span style=color:#5fb3b3>%</span><span>)
</span></code></pre><p>These commands provide a solid foundation, but there are additional features worth exploring.<h3 id=extra-features>Extra features</h3><h4 id=budget-management>Budget management</h4><p>Tracking metrics is useful, but the goal is to improve the codebase or project. One way to ensure this is by blocking commits that don‚Äôt meet certain metric criteria, a feature already used by many external services.<p>With <code>git-metrics</code>, you can configure rules by adding a <code>.git-metrics.toml</code> file to your repository:<pre class=language-toml data-lang=toml style=color:#cccece;background-color:#2b2c2f><code class=language-toml data-lang=toml><span style=color:#5f6364># fails when increase size is above 10%
</span><span style=color:#5fb3b3>[[metrics.binary-size.rules]]
</span><span style=color:#eb606b>type </span><span style=color:#5fb3b3>= "</span><span style=color:#99c794>max-increase</span><span style=color:#5fb3b3>"
</span><span style=color:#eb606b>ratio </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>0.1
</span><span>
</span><span style=color:#5f6364># fails when the size increases by more that 1MB
</span><span style=color:#5fb3b3>[[metrics.binary-size.rules]]
</span><span style=color:#eb606b>type </span><span style=color:#5fb3b3>= "</span><span style=color:#99c794>max-increase</span><span style=color:#5fb3b3>"
</span><span style=color:#eb606b>value </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>1048576.0
</span><span>
</span><span style=color:#5f6364># fails when binary size is more than 10MB
</span><span style=color:#5fb3b3>[[metrics.binary-size.rules]]
</span><span style=color:#eb606b>type </span><span style=color:#5fb3b3>= "</span><span style=color:#99c794>max</span><span style=color:#5fb3b3>"
</span><span style=color:#eb606b>value </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>10485760.0
</span><span>
</span><span style=color:#5f6364># fails when the code coverage goes below 80%
</span><span style=color:#5fb3b3>[[metrics."</span><span style=color:#99c794>coverage.lines.percentage</span><span style=color:#5fb3b3>".rules]]
</span><span style=color:#eb606b>type </span><span style=color:#5fb3b3>= "</span><span style=color:#99c794>min</span><span style=color:#5fb3b3>"
</span><span style=color:#eb606b>value </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>0.8
</span><span>
</span><span style=color:#5f6364># fails when the code coverage decreases of more than 5%
</span><span style=color:#5fb3b3>[[metrics."</span><span style=color:#99c794>coverage.lines.percentage</span><span style=color:#5fb3b3>".rules]]
</span><span style=color:#eb606b>type </span><span style=color:#5fb3b3>= "</span><span style=color:#99c794>max-decrease</span><span style=color:#5fb3b3>"
</span><span style=color:#eb606b>ratio </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>0.05
</span></code></pre><p>Running <code>git-metrics check</code> from your CI after adding your metrics will inform you if your changes meet the specified budget.<h4 id=importing-from-other-file-formats>Importing from other file formats</h4><p>Manually adding metrics with the <code>add</code> command can be cumbersome, especially for derived metrics. For instance, after computing code coverage, you might end up with an <code>lcov</code> file, which needs to be processed to extract useful metrics. <code>git-metrics</code> can handle this:<pre class=language-bash data-lang=bash style=color:#cccece;background-color:#2b2c2f><code class=language-bash data-lang=bash><span style=color:#69c>$ git-metrics import lcov ./lcov.info
</span></code></pre><p>This command adds summary metrics such as <code>coverage.lines.count</code>, <code>coverage.functions.hit</code>, or <code>coverage.branches.percentage</code>.<p>Currently, <code>git-metrics</code> supports only <code>lcov</code> files, but more formats will be supported as the tool evolves.<h2 id=conclusion>Conclusion</h2><p><code>git-metrics</code> is in its early stages but already provides essential commands for tracking metrics, creating budgets, and blocking contributions that don‚Äôt meet the budget criteria, all within your git repository.<p>Similar to the mentioned SaaS solutions, git-metrics offers <a href=https://github.com/jdrouet/action-git-metrics rel=noopener target=_blank>GitHub actions</a> for installation, tracking, and checking metrics. GitLab support is expected soon.</div><div class=page-footer><a href="https://github.com/jdrouet/jdrouet.github.io/blob/main/content/posts/202408041030-git-metrics.md?plain=1" title="Help improve page /posts/202408041030-git-metrics/" target=_blank>Suggest improvements</a></div></article></main></div><footer><a alt="Send me an email" class=text-xxl href=mailto:contact@jdrouet.fr target=_blank> <i class="icon icon-mail"></i> </a><a alt="My GitHub profile" class=text-xxl href=https://github.com/jdrouet target=_blank> <i class="icon icon-github"></i> </a><a alt="My LinkedIn profile" class=text-xxl href=https://www.linkedin.com/in/jeremiedrouet target=_blank> <i class="icon icon-linkedin"></i> </a><a alt="Follow me on Mamot" class=text-xxl href=https://mamot.fr/@jdrouet target=_blank> <i class="icon icon-mastodon"></i> </a><a alt="Follow my RSS feed" class=text-xxl href=/atom.xml target=_blank> <i class="icon icon-rss"></i> </a><span class=copyright>¬© 2023 - 2025 J√©r√©mie Drouet</span></footer>